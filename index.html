<!DOCTYPE html>
<html>
	<head>
		 <title>AR Photobooth</title>
		 <style>
			html, body{ margin: 0; padding: 0; }
			video, .overlay{ position: absolute; top: 0; left: 0; }
			#box{ border: 1px solid red; height: 10px; width: 10px; }
			.overlay{ opacity: 0; z-index: 5; transition: all 0.05s ease-in-out;}
			#options{ position: absolute; right: 0;}
			.option{ float: left; width: 100px; border: 1px solid #343434;  margin-left: 20px;}
			#options h3{ margin-left: 20px; }
			#video{ display: none; }
			#canvas{ margin-left: 250px; }
		 </style>
	</head>
	<body>
		<video id="video" autoplay loop></video>
		<canvas id="canvas"></canvas>
		
		<div id="box" class="overlay"></div>
		<img src="images/glasses.png" id="glasses" class="overlay">
		
		<div id="options">
			<h3>Select any object:</h3>
			<img src="images/glasses.png" class="option">
			<img src="images/g2.png" class="option">
		</div>
		<div>
			<a id="capture" download="image.png">Capture</a>
		</div>
		<img src="" id="preview">
		
		<script src="js/objectdetect.js"></script>
		<script src="js/objectdetect.frontalface.js"></script>
		<script src="js/objectdetect.eye.js"></script>	
		<script type="text/javascript">
			
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
			window.URL = window.URL || window.webkitURL;
			if (navigator.getUserMedia === undefined) {
				alert("Browser doesn't support getUserMedia");
			}

			window.onload = function(){
				var video = document.getElementById('video'),
				box = document.getElementById('glasses'),
				canvas = document.getElementById('canvas'),
				context = canvas.getContext('2d'),
				detector, eyeDetector, face, preCoordi = preLeftEye =  preRightEye = [0, 0, 0, 0],
				 MIN_FACE_CHANGE = 1, MIN_EYE_CHANGE = 5, MIN_FACE_CONFI = 4, MIN_EYE_CONFI = 2;

				navigator.getUserMedia({video: true}, function (stream) {
					video.src = window.URL.createObjectURL(stream);
					video.addEventListener('canplay', draw);
				}, function() {});

				function draw(){
					if (video.paused) video.play();
					if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
						
							canvas.width = video.videoWidth;
							canvas.height = video.videoHeight;
							context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
							
							if (!detector){
								detector = new objectdetect.detector((60 * video.videoWidth / video.videoHeight), 60, 1.1, objectdetect.frontalface);
							}
							var coords = detector.detect(canvas, 1);
							
							// check if face is detected
							if(coords[0] && coords[0][4] > MIN_FACE_CONFI){								
								console.log(coords[0]);
								if (Math.abs(coords[0][0] - preCoordi[0]) > MIN_FACE_CHANGE || Math.abs(coords[0][1] - preCoordi[1]) > MIN_FACE_CHANGE){
									preCoordi = coords[0];
								} else{
									coords[0] = preCoordi;
								}

								var wFactor = video.videoWidth / detector.canvas.width,
								hFactor = video.videoHeight / detector.canvas.height,
								faceWidth = coords[0][2] * wFactor,
								faceHeight = coords[0][3] * hFactor,
								faceX = coords[0][0] * wFactor,
								faceY = coords[0][1] * hFactor;

								/*if (!eyeDetector){
									eyeDetector = new objectdetect.detector((60 * faceWidth / faceHeight), 60, 1.1, objectdetect.eye);
								}
								eyes = eyeDetector.detect(canvas, 1, 1, [faceX, faceY, faceWidth, faceHeight]);
								//console.log(eyes);

								// if eyes are detected
								if (eyes.length > 1 && (Math.abs(eyes[0][0] - preLeftEye[0]) > MIN_EYE_CHANGE || Math.abs(eyes[0][1] - preLeftEye[1])) > MIN_EYE_CHANGE){
									preLeftEye = eyes[0];
									if (eyes.length == 2) preRightEye = eyes[1];
								} else{
									if (preLeftEye[0] != 0) eyes[0] = preLeftEye;
									if (preRightEye[0] != 0) eyes[1] = preRightEye;
								}

								if ((eyes.length == 1 || eyes.length == 2) && eyes[0][4] > MIN_EYE_CONFI && eyes[0][0] < eyes[0][2] / 2){
									
									var wf = faceWidth / eyeDetector.canvas.width,
									hf = faceHeight / eyeDetector.canvas.height,
									angle;

									// if both eyes are detected then ovelay can be rotated
									if (eyes.length == 2){
										angle =  Math.atan((eyes[1][1]*hf - eyes[0][1]*hf) / faceWidth);
									// if only left eye
									} else{
										angle = 0;
									}
									context.rotate(angle);
									context.drawImage(box, faceX + eyes[0][0]*wf, faceY + eyes[0][1]*hf, faceWidth*0.75, eyes[0][2]*hf);
									// context.rect(faceX + eyes[0][0]*wf, faceY + eyes[0][1]*hf , faceWidth*0.75, eyes[0][3]*hf);
									// context.stroke();
									context.rotate(-angle);
									
									// to draw boxes around detected eyes
									// for(var i = 0; i < eyes.length; i++){
									// 	context.rect(faceX + eyes[i][0]*wf, faceY + eyes[i][1]*hf , eyes[i][2]*wf, eyes[i][3]*hf);
									// 	context.stroke();
									// }

								// if only right eye or no eyes are detect
								} else{
								}*/
								context.drawImage(box, video.offsetLeft + faceX + 0.125 * faceWidth, video.offsetTop + faceY + 0.31 * faceHeight, faceWidth * 0.75, faceWidth * 0.75 * box.height / box.width);
								// to draw a box	
								// context.rect(faceX, faceY, faceWidth, faceHeight);
								// context.stroke();
							}						
					}
					requestAnimationFrame(draw);
				}

				var options = document.getElementsByClassName('option');
				for (var i = 0; i < options.length; i++) {
					options[i].addEventListener('click', function(){
						box.src = this.getAttribute('src');
					});
				}

				document.getElementById('capture').addEventListener('click', function(){
					var image = canvas.toDataURL('image/jpg');
					var preview = document.getElementById('preview');
					preview.src = image;
					this.href = image;
					//window.location.href = image;

					// to save directly
					/*var aLink = document.createElement('a');
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent("click");
                aLink.download = 'image.png';
                aLink.href = image;
                aLink.dispatchEvent(evt);*/
				});
			}
		</script>
	</body>
</html>